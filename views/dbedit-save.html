{% extends parentTemplate %}

{% block head %}
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script type="text/javascript">
  function dbeditAddMore(colName) {
    var inputCol = document.getElementsByName(colName)[0];
    var oCopy = $(inputCol).clone();
    oCopy.val("");
    
    $(inputCol).parent().parent().append($('<div class="mb-3"></div>').append(oCopy));
  }

  function onChangeSelectAll(selectAllCtrl) {
    var jSelectAll = $(selectAllCtrl);

    var inputName = jSelectAll.prop('id').split('_')[2];
    $('input[name="' + inputName + '"]').prop('checked', jSelectAll.prop('checked'))
  }

  function onChangeCheckNonSelectAll(selectAllCtrl) {
    var jSelectAll = $(selectAllCtrl);

    var inputName = jSelectAll.prop('id').split('_')[2];

    var allChecked = true;
    $('input:checkbox[name="' + inputName + '"]').each(function(index) {
      if (!$(this).prop('checked')) {
        allChecked = false;
        return false;
      }
    })
    jSelectAll.prop('checked', allChecked);
  }

  $(document).ready(function() {
    $('.c-selectall').each(function() {
      var self = this;
      var jSelectAll = $(self);
      jSelectAll.change(function() {
        onChangeSelectAll(self)
      });

      var inputName = jSelectAll.prop('id').split('_')[2];

      $('input[name="' + inputName + '"]').change(function() {
        onChangeCheckNonSelectAll(self)
      });

      onChangeCheckNonSelectAll(self);
    });
  })

</script>
{% endblock %}

{% block content %}
{{super()}}

<div class="row">
<div class="col"{%if style%} style="{{style}}"{%endif%}>

<form method="post">
  <input type="hidden" name="_csrf" value="{{_csrf}}" />
  <input type="hidden" name="_id" value="{{rec._id}}" />
{%if queryModelName%}
  <input type="hidden" name="modelName" value="{{queryModelName}}" />
{%endif%}
  <input type="hidden" name="_backUrl" value="{{redirectAfter}}" />

{%for colName in filterCols%}

  {%set dbCol = modelAttr.schema[colName]%}
  {%set attrName = colMap[colName].inputName%}

  {%set colLabel = colMap[colName].label%}
  {%set inputType = colMap[colName].inputType%}
  {%set isColReadOnly = colMap[colName].readOnlyComputed %}
  {%set isColRequired = colMap[colName].required%}
  {%set isColVisible = colMap[colName].visibleComputed%}

  {%set copies = colMap[colName].copies%}
  {%set isMultiple = colMap[colName].multiple%}
 
{%if isColVisible%}

{%if colMap[colName].attachToPrevious%}
  </div><div class="col-sm">
{%else%}
  {%if loop.index != 1%}</div></div>{%endif%}

  <div class="row">  
  <div class="col-sm">
{%endif%}


  <div class="form-group">
    {%if colLabel%}
      <label>{{colLabel}} {%if isColRequired and not isColReadOnly%}<super class="text-danger">*</super>{%endif%}</label>
    {%endif%}

  {%set colVal = rec[colName]%}
  {%set htmlValue = colMap[colName].htmlValue%}
  {%set propsHtml = colMap[colName]._propsHtml%}
   
  {% for i in range(0, copies) -%}
    <div class="mb-3">

    
    {%if isMultiple%}
      {%set colVal = rec[colName][i]%}
      {%if not colVal and loop.index == 1%}
        {%set colVal = colMap[colName].default%}
      {%endif%}
    {%endif%}

    {%if htmlValue%}
      {{htmlValue | safe}}
    {%elif isColReadOnly %}

      {% marked %}{% if colMap[colName].lookup %}{{ colMap[colName].lookup[colVal] }}{% elif colMap[colName].inputValues %}{{ colMap[colName].inputValues.get(colVal) }}{% else %}{{ colVal }}{% endif %}{% endmarked %}

    {%elif inputType == 'select'%}

      <select class="form-control" name="{{attrName}}" {%if colMap[colName].required%} required{%endif%}{{propsHtml | safe}}>
        {%for key, val in colMap[colName].inputValues%}

        <option value="{{key}}"{%if (colVal.equals and colVal.equals(key) or (colVal == key))%} selected{%endif%}>{{val}}</option>

        {%endfor%}
      </select>

    {%elif inputType == 'date'%}

      <input class="flatpickr-date form-control" name="{{attrName}}" value="{{colVal | date('MM/DD/YYYY')}}" placeholder="MM/DD/YYYY"{%if colMap[colName].required%} required{%endif%}{{propsHtml | safe}}>

    {%elif inputType == 'datetime'%}

      <input class="flatpickr-datetime form-control" name="{{attrName}}" value="{{colVal | date('MM/DD/YYYY hh:mm A', 'Asia/Manila')}}" placeholder="MM/DD/YYYY hh:mm A"{%if colMap[colName].required%} required{%endif%}{{propsHtml | safe}}>

    {%elif inputType == 'checkbox'%}

      {%if colMap[colName].showSelectAll%}
      <div class="form-check">
          <input class="c-selectall form-check-input" type="checkbox" value="" id="c_SELECTALL_{{attrName}}">
          <label class="form-check-label" for="c_SELECTALL_{{attrName}}"{{propsHtml | safe}}>
            Select All
          </label>
        </div>
      {%endif%}
        
      {# Need to do this because selecting none won't save it#}
      <input type="hidden" value="" name="{{attrName}}"{{propsHtml | safe}}>

      {%for key, val in colMap[colName].inputValues%}

        <div class="form-check">
          <input name="{{attrName}}" class="form-check-input" type="checkbox" value="{{key}}" id="c_{{attrName}}_{{key}}"{%if colMap[colName].required%} required{%endif%}{%if rec[colName] and rec[colName].indexOf(key) != -1%} checked{%endif%}>
          <label class="form-check-label" for="c_{{attrName}}_{{key}}">
            {{val}}
          </label>
        </div>

      {%endfor%}

    {%else%}
      <input class="form-control" name="{{attrName}}" value="{{colVal}}"{%if colMap[colName].required%} required{%endif%}{%if colMap[colName].placeholder%} placeholder="{{colMap[colName].placeholder}}"{%endif%} {{propsHtml | safe}}>
    {%endif%}


     
    {%if colMap[colName].hint%}
    <small class="form-text text-muted">
        {{colMap[colName].hint}}
    </small>
    {%endif%}
     </div>
    {%endfor%}

  </div>

  {%if isMultiple and inputType != 'checkbox' %}
    <div class="form-row">
      <div class="col-md mt-0">
        <button type="button" class="btn btn-secondary pull-right" onclick="dbeditAddMore('{{attrName}}'); return false;">Add More</button>
      </div>
    </div>
  {%endif%}


  {%if loop.last%}
  </div></div>
  {%endif%}

{%endif%}
{%endfor%}

  
  <div class="row">
    <div class="col mb-3">
      <button type="submit" class="btn btn-primary" name="_ACTION_SAVE">Save</button>
    </div>
  </div>

   
   {%for submitBtnObj in additionalSubmitButtons%}
   {%if submitBtnObj.visibleComputed%}
   <div class="row">
     <div class="col mb-3">
       <button type="submit" class="{{submitBtnObj.class}}" name="{{submitBtnObj.actionName}}"{%if submitBtnObj.confirm%} onclick="return confirm('{{submitBtnObj.confirm}}')"{%endif%}>{{submitBtnObj.title}}</button>
      </div>
   </div>
   {%endif%}
   {%endfor%}
  

  

</form>

{%if isUpdateMode and shouldShowDeleteAction%}
  <form class="form-inline" method="POST" action="list" style="float: right; position: absolute; right: 15px; bottom: 0px;">
    <input type="hidden" name="_csrf" value="{{_csrf}}" />
    <input type="hidden" name="_id" value="{{rec._id}}" />
    <input type="hidden" name="_backUrl" value="{{redirectAfter}}" />
    {%if queryModelName%}
    <input type="hidden" name="model" value="{{queryModelName}}" />
    {%endif%}
    <button type="submit" name="ACTION_DELETE" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this record?')" >Delete</button>
  </form>
  
{%endif%}

</div>
</div>

{% endblock %}

{% block beforeEndBody %}


<script src="//cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  $(function() {
    $(".flatpickr-date").flatpickr({dateFormat: 'm/d/Y', allowInput: true});
    $(".flatpickr-datetime").flatpickr({dateFormat: 'm/d/Y h:i K', enableTime: true, allowInput: true});
  })
</script>


<script src="/public/js/unsaved-changes-prompt.js"></script>
<script src="/public/js/unsaved-changes-prompt-all.js"></script>


{% endblock %}